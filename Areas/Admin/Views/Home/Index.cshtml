@using Microsoft.AspNetCore.Html
@using DebtSnowballApp.Areas.Admin.ViewModels
@model IEnumerable<DebtSnowballApp.Models.ApplicationUser>
@{
    var sort = (string)(ViewBag.Sort ?? "name");
    var dir = (string)(ViewBag.Dir ?? "asc");
    var q = (string)(ViewBag.Query ?? "");
}

<div class="container py-4">
    @* optional toolbar *@
    @if (ViewData["Toolbar"] is AdminListToolbarModel toolbar)
    {
        @await Html.PartialAsync("_AdminListToolbar", toolbar)
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-striped table-hover align-middle w-100">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>
							<a asp-area="Admin" asp-controller="Users" asp-action="Index"
							   asp-route-sort="name" asp-route-dir="@(sort=="name" && dir=="asc" ? "desc" : "asc")"
							   asp-route-q="@q" class="text-decoration-none">
								Name @(sort == "name" ? (dir == "asc" ? "▲" : "▼") : "")
							</a>
						</th>
						<th>
							<a asp-area="Admin" asp-controller="Users" asp-action="Index"
							   asp-route-sort="UserName" asp-route-dir="@(sort=="UserName" && dir=="asc" ? "desc" : "asc")"
							   asp-route-q="@q" class="text-decoration-none">
								UserName @(sort == "UserName" ? (dir == "asc" ? "▲" : "▼") : "")
							</a>
						</th>
						<th>
                            <a asp-area="Admin" asp-controller="Users" asp-action="Index"
                               asp-route-sort="email" asp-route-dir="@(sort=="email" && dir=="asc" ? "desc" : "asc")"
                               asp-route-q="@q" class="text-decoration-none">
                                Email @(sort == "email" ? (dir == "asc" ? "▲" : "▼") : "")
                            </a>
                        </th>
                        <th>
                            <a asp-area="Admin" asp-controller="Users" asp-action="Index"
                               asp-route-sort="partner" asp-route-dir="@(sort=="partner" && dir=="asc" ? "desc" : "asc")"
                               asp-route-q="@q" class="text-decoration-none">
                                Partner @(sort == "partner" ? (dir == "asc" ? "▲" : "▼") : "")
                            </a>
                        </th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in Model)
                    {
                        <tr>
                            <td>
                                @{
                                    var isLocked = (u.LockoutEnabled && u.LockoutEnd.HasValue && u.LockoutEnd > DateTimeOffset.UtcNow);
                                }
                                @if (!u.LockoutEnabled)
                                {
                                    <span class="badge bg-secondary">Disabled</span>
                                }
                                else if (isLocked)
                                {
                                    <span class="badge bg-danger">Locked</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                            </td>
                            <td>@(string.Join(' ', new[] { u.FirstName, u.LastName }.Where(s => !string.IsNullOrWhiteSpace(s))))</td>
                            <td>@u.UserName</td>
							<td>@u.Email</td>
							<td>@u.Partner?.Name</td>
                            <td class="text-end">
                                <a asp-area="Admin" asp-controller="Users" asp-action="Details" asp-route-id="@u.Id"
                                   class="btn btn-sm btn-outline-primary me-1">Details</a>
                                <a asp-area="Admin" asp-controller="Users" asp-action="Edit" asp-route-id="@u.Id"
                                   class="btn btn-sm btn-outline-secondary">Edit</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<style>
    .admin-table thead a {
        color: #fff;
    }

        .admin-table thead a:hover {
            opacity: .85;
        }

    tr.js-user-row.active {
        outline: 2px solid rgba(0,0,0,.1);
        background: rgba(0,0,0,.02);
    }
</style>

<script>
    (function(){
      const host = document.getElementById('userProfileHost');
      const rows = document.querySelectorAll('tr.js-user-row');

      async function loadProfile(id, pushUrl=true){
        if(!id || !host) return;
        host.classList.remove('d-none');
        host.innerHTML = '<div class="text-center py-4">Loading…</div>';

        try{
          const res = await fetch(`@Url.Action("ProfileCard", "Users", new { area = "Admin" })?id=${encodeURIComponent(id)}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
          if(!res.ok){ host.innerHTML = '<div class="alert alert-warning m-0">Unable to load profile.</div>'; return; }
          host.innerHTML = await res.text();

          // update querystring for deep-link
          const qp = new URLSearchParams(window.location.search);
          if(pushUrl) {
            qp.set('selected', id);
            history.replaceState({}, '', `${location.pathname}?${qp}`);
          }
        }catch{
          host.innerHTML = '<div class="alert alert-danger m-0">Error loading profile.</div>';
        }
      }

      rows.forEach(r => {
        r.addEventListener('click', () => {
          rows.forEach(x => x.classList.remove('active'));
          r.classList.add('active');
          const id = r.getAttribute('data-id');
          loadProfile(id);
        });
      });

      // Deep-link support ?selected=<id>
      const params = new URLSearchParams(window.location.search);
      const preselected = params.get('selected');
      if(preselected){
        const row = Array.from(rows).find(x => x.getAttribute('data-id') === preselected);
        if(row){ row.classList.add('active'); }
        loadProfile(preselected, false);
      }
    })();
</script>
